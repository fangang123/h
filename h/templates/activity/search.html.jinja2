{% extends "h:templates/layouts/base.html.jinja2" %}

{% from '../includes/annotation_card.html.jinja2' import annotation_card %}

{# Card displaying statistics about a bucket of annotations. #}
{% macro search_bucket_stats(bucket) %}
<div class="search-bucket-stats">
  {% if bucket.uri %}
    <div class="search-bucket-stats__key">
        Address
    </div>
    <div class="search-bucket-stats__val search-bucket-stats__address">
        {{ bucket.uri }}
    </div>
  {% endif %}
  {% if bucket.tags %}
    <div class="search-bucket-stats__key">
      Tags
    </div>
    <ul class="search-bucket-stats__val">
      {% for tag in bucket.tags %}
        <li>{{ tag }}</li>
      {% endfor %}
    </ul>
  {% endif %}
  <div class="search-bucket-stats__key">
    Annotators
  </div>
  <ul class="search-bucket-stats__val">
    {% for user in bucket.users %}
      <li class="search-bucket-stats__username">
        {{ user.split(':')[1].split('@')[0] }}
      </li>
    {% endfor %}
  </ul>
</div>
{% endmacro %}

{#
  A collapsible bucket/group of annotations
#}
{% macro search_result_bucket(bucket) %}
<div class="search-result-bucket js-search-bucket">

  {# The header is the clickable area that expands/collapses the bucket when
     clicked #}
  <div class="search-result-bucket__header" data-ref="header">
    <div class="search-result-bucket__domain">
      {{ bucket.domain }}
    </div>
    <div class="search-result-bucket__title-and-annotations-count">
        <div class="search-result-bucket__title">
        {% if bucket.title %}
            {{ bucket.title }}
        {% else %}
            {% trans %}Untitled document{% endtrans %}
        {% endif %}
        </div>
        <div class="search-result-bucket__annotations-count">
        <div class="search-result-bucket__annotations-count-container">
            {{ bucket.annotations_count }}
        </div>
    </div>
    </div>
  </div>

  {# The content is the area that appears / disappears on expand / collapse. #}
  <div class="search-result-bucket__content">
    <div class="search-result-bucket__annotation-cards-container" data-ref="content">
      <ol class="search-result-bucket__annotation-cards">
        {% for result in bucket.annotations %}
          {{ annotation_card(result.annotation, request) }}
        {% endfor %}
      </ol>
      {{ search_bucket_stats(bucket) }}
    </div>
  </div>
</div>
{% endmacro %}

{% block content %}

  {{ panel('navbar') }}

  <div class="search-result-container">
    <ol class="search-result-list">
      {% for timeframe in timeframes %}
        <li class="search-result__timeframe">
          {{ timeframe.label }}
        </li>
        <li>
          {% for bucket in timeframe.document_buckets.values() %}
            {{ search_result_bucket(bucket) }}
          {% endfor %}
        </li>
      {% endfor %}
    </ol>

    {% if group %}
    <aside class="search-result-sidebar">
      <h1 class="search-result-sidebar__title">{{ group.name }}</h1>

      {% if group.description %}
      <section class="search-result-sidebar__section">
        {% for paragraph in group.description.split('\n') %}
          <p>{{ paragraph }}</p>
        {% endfor %}
      </section>
      {% endif %}

      <section class="search-result-sidebar__section">
        <dl>
          <dt class="search-result-sidebar__dt">
            {% trans %}Annotations:{% endtrans %}
          </dt>
          <dd class="search-result-sidebar__dd">{{ total }}</dd>

          <dt class="search-result-sidebar__dt">
            {% trans %}Created:{% endtrans %}
          </dt>
          <dd class="search-result-sidebar__dd">{{ group.created }}</dd>
        </dl>
        <div style="clear: both;"></div>
      </section>

      <section class="search-result-sidebar__section">
        <ul>
          {% if group_edit_url %}
            <li>
              <a class="search-result-sidebar__link"
                 href="{{ group_edit_url }}">
                {% trans %}Edit group{% endtrans %}
              </a>
            </li>
          {% endif %}
          {% if show_group_leave_button %}
            <li>
              {#- This form element is needed for Internet Explorer because it
                  doesn't support the `form` attribute. See commit message. #}
              <form method="POST">
                <button class="search-result-sidebar__leave-button js-confirm-submit"
                        form="search-bar"
                        formmethod="POST"
                        type="submit"
                        name="group_leave"
                        value="{{ group.pubid }}"
                        data-confirm-message="Are you sure you want to leave the group &quot;{{ group.name }}&quot;?">
                    {% trans %}Leave this group{% endtrans %}
                </button>
              </form>
            </li>
          {% endif %}
        </ul>
      </section>

      <section class="search-result-sidebar__section">
        <h3 class="search-result-sidebar__subtitle">
          {% trans %}Members{% endtrans %}
          <span class="search-result-sidebar-title__annotations-count">
            {{ aggregations.users|length }}
          <span>
        </h3>
        <ul>
          {% for user in aggregations.users %}
            <li>
              <a class="search-result-sidebar__username">
                {{ user.username }}
              </a>
              <span class="search-result-sidebar__annotations-count">
                {{ user.count }}
              </span>
            </li>
          {% endfor %}
        </ul>
      </section>
    </aside>
    {% endif %}
  </div>

  {% if page and page.max > 1 %}
    {% include "h:templates/includes/paginator.html.jinja2" %}
  {% endif %}
{% endblock %}
